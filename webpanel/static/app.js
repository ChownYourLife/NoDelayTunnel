const I18N = {
  fa: {
    'doc.title': 'ŸæŸÜŸÑ NoDelay',
    'app.title': 'üöÄ ŸæŸÜŸÑ NoDelay',
    'app.subtitle': 'ŸÖÿßŸÜ€åÿ™Ÿàÿ±€åŸÜ⁄Ø ŸÖŸÜÿßÿ®ÿπÿå Ÿàÿ∂ÿπ€åÿ™ ÿ™ŸàŸÜŸÑ‚ÄåŸáÿß Ÿà ŸÖÿØ€åÿ±€åÿ™ ÿ≥ÿ±Ÿà€åÿ≥‚ÄåŸáÿß',
    'app.lang': 'üåê ÿ≤ÿ®ÿßŸÜ',
    'btn.refresh': 'üîÑ ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å',
    'btn.create_tunnel': '‚ûï ÿ≥ÿßÿÆÿ™ ÿ™ŸàŸÜŸÑ',
    'btn.load_logs': 'üì• ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å',
    'btn.cancel': 'ŸÑÿ∫Ÿà',
    'btn.create_apply': '‚úÖ ÿß€åÿ¨ÿßÿØ / ÿßÿπŸÖÿßŸÑ',
    'btn.save': 'üíæ ÿ∞ÿÆ€åÿ±Ÿá',
    'resources.title': 'üìä ŸÖŸÜÿßÿ®ÿπ ÿ≥ÿ±Ÿàÿ±',
    'resources.cpu': 'üß† CPU',
    'resources.mem': 'üßÆ ÿ≠ÿßŸÅÿ∏Ÿá',
    'resources.disk': 'üíæ ÿØ€åÿ≥⁄©',
    'resources.load': '‚öñÔ∏è Load',
    'resources.uptime': '‚è±Ô∏è ÿ¢Ÿæ‚Äåÿ™ÿß€åŸÖ',
    'resources.net': 'üì° ÿ™ÿ±ÿßŸÅ€å⁄© ŸÖ€åÿ≤ÿ®ÿßŸÜ',
    'tunnels.title': 'üõ£Ô∏è ÿ™ŸàŸÜŸÑ‚ÄåŸáÿß',
    'table.service': 'ÿ≥ÿ±Ÿà€åÿ≥',
    'table.role': 'ŸÜŸÇÿ¥',
    'table.status': 'Ÿàÿ∂ÿπ€åÿ™',
    'table.profile_mode': 'Ÿæÿ±ŸàŸÅÿß€åŸÑ / ŸÖŸàÿØ',
    'table.endpoints': 'ÿßŸÜÿØŸæŸà€åŸÜÿ™‚ÄåŸáÿß',
    'table.throughput': 'ŸÜÿ±ÿÆ ÿπÿ®Ÿàÿ±',
    'table.actions': 'ÿßŸÇÿØÿßŸÖÿßÿ™',
    'logs.title': 'üìú ŸÑÿß⁄Ø‚ÄåŸáÿß',
    'logs.hint': '€å⁄© ÿ™ŸàŸÜŸÑ ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ Ÿà ŸÑÿß⁄Ø ÿ±ÿß ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄©ŸÜ€åÿØ.',
    'create.title': 'üß© ÿ≥ÿßÿÆÿ™ ÿ™ŸàŸÜŸÑ',
    'edit.title': 'üìù Ÿà€åÿ±ÿß€åÿ¥ ⁄©ÿßŸÜŸÅ€å⁄Ø',
    'edit.restart': 'ÿ±€å‚Äåÿßÿ≥ÿ™ÿßÿ±ÿ™ ÿ≥ÿ±Ÿà€åÿ≥ ÿ®ÿπÿØ ÿßÿ≤ ÿ∞ÿÆ€åÿ±Ÿá',
    'role.server': 'ÿ≥ÿ±Ÿàÿ±',
    'role.client': '⁄©ŸÑÿß€åŸÜÿ™',
    'form.role': 'ŸÜŸÇÿ¥',
    'form.instance': 'ÿß€åŸÜÿ≥ÿ™ŸÜÿ≥',
    'form.tunnel_mode': 'ŸÖŸàÿØ ÿ™ŸàŸÜŸÑ',
    'form.profile': 'Ÿæÿ±ŸàŸÅÿß€åŸÑ',
    'form.transport': 'ÿ™ÿ±ŸÜÿ≥ŸæŸàÿ±ÿ™',
    'form.port': 'ŸæŸàÿ±ÿ™',
    'form.server_addr': 'ÿ¢ÿØÿ±ÿ≥ ÿ≥ÿ±Ÿàÿ± (⁄©ŸÑÿß€åŸÜÿ™)',
    'form.listen_host': 'Listen Host (ÿ≥ÿ±Ÿàÿ±)',
    'form.path': 'ŸÖÿ≥€åÿ±',
    'form.psk': 'PSK',
    'form.pool_size': 'Pool Size (⁄©ŸÑÿß€åŸÜÿ™)',
    'form.strategy': 'ÿßÿ≥ÿ™ÿ±ÿßÿ™⁄ò€å (⁄©ŸÑÿß€åŸÜÿ™)',
    'form.mux': 'Mux',
    'form.advanced_yaml': 'YAML Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá (ÿßÿÆÿ™€åÿßÿ±€å)',
    'ph.instance': 'default',
    'ph.server_addr': '1.2.3.4',
    'ph.listen_host': 'empty = all interfaces',
    'ph.psk': 'optional',
    'ph.advanced_yaml': 'ÿß⁄Øÿ± ŸÖŸÇÿØÿßÿ± ÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥ÿØÿå ŸáŸÖÿßŸÜ YAML ŸÖÿ≥ÿ™ŸÇ€åŸÖ ÿ∞ÿÆ€åÿ±Ÿá ŸÖ€å‚Äåÿ¥ŸàÿØ.',
    'updated.prefix': '‚è∞ ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å',
    'table.no_tunnels': 'Ÿá€å⁄Ü ÿ≥ÿ±Ÿà€åÿ≥ ÿ™ŸàŸÜŸÑ€å Ÿæ€åÿØÿß ŸÜÿ¥ÿØ.',
    'thr.down': 'ÿØÿßŸÜŸÑŸàÿØ',
    'thr.up': 'ÿ¢ŸæŸÑŸàÿØ',
    'thr.total': 'ÿ≠ÿ¨ŸÖ ⁄©ŸÑ',
    'action.start': 'ÿ¥ÿ±Ÿàÿπ',
    'action.stop': 'ÿ™ŸàŸÇŸÅ',
    'action.restart': 'ÿ±€å‚Äåÿßÿ≥ÿ™ÿßÿ±ÿ™',
    'action.edit': 'Ÿà€åÿ±ÿß€åÿ¥',
    'action.delete': 'ÿ≠ÿ∞ŸÅ',
    'logs.select_error': 'ÿ®ÿ±ÿß€å ŸÑÿß⁄Øÿå ÿ™ŸàŸÜŸÑ ÿßŸÜÿ™ÿÆÿßÿ® ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™.',
    'logs.no_output': '(ÿÆÿ±Ÿàÿ¨€å ŸÑÿß⁄Ø€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ)',
    'editor.empty': 'YAML ⁄©ÿßŸÜŸÅ€å⁄Ø ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿÆÿßŸÑ€å ÿ®ÿßÿ¥ÿØ.',
    'toast.created': 'ÿ™ŸàŸÜŸÑ ÿß€åÿ¨ÿßÿØ/ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ',
    'toast.saved': 'ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ: {{service}}',
    'toast.deleted': 'ÿ≠ÿ∞ŸÅ ÿ¥ÿØ: {{service}}',
    'toast.action': '{{service}}: {{action}} ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØ',
    'confirm.delete': 'ÿ≥ÿ±Ÿà€åÿ≥ {{service}} Ÿà ⁄©ÿßŸÜŸÅ€å⁄Ø ÿ¢ŸÜ ÿ≠ÿ∞ŸÅ ÿ¥ŸàÿØÿü',
    'status.unknown': 'ŸÜÿßŸÖÿ¥ÿÆÿµ',
    'time.day': 'ÿ±Ÿàÿ≤',
    'time.hour': 'ÿ≥ÿßÿπÿ™',
    'time.min': 'ÿØŸÇ€åŸÇŸá',
  },
  en: {
    'doc.title': 'NoDelay Web Panel',
    'app.title': 'üöÄ NoDelay Web Panel',
    'app.subtitle': 'Monitor resources, tunnel status, throughput, and manage instances',
    'app.lang': 'üåê Language',
    'btn.refresh': 'üîÑ Refresh',
    'btn.create_tunnel': '‚ûï Create Tunnel',
    'btn.load_logs': 'üì• Load',
    'btn.cancel': 'Cancel',
    'btn.create_apply': '‚úÖ Create / Apply',
    'btn.save': 'üíæ Save',
    'resources.title': 'üìä Server Resources',
    'resources.cpu': 'üß† CPU',
    'resources.mem': 'üßÆ Memory',
    'resources.disk': 'üíæ Disk',
    'resources.load': '‚öñÔ∏è Load',
    'resources.uptime': '‚è±Ô∏è Uptime',
    'resources.net': 'üì° Host Throughput',
    'tunnels.title': 'üõ£Ô∏è Tunnels',
    'table.service': 'Service',
    'table.role': 'Role',
    'table.status': 'Status',
    'table.profile_mode': 'Profile / Mode',
    'table.endpoints': 'Endpoints',
    'table.throughput': 'Throughput',
    'table.actions': 'Actions',
    'logs.title': 'üìú Logs',
    'logs.hint': 'Select a tunnel and load logs.',
    'create.title': 'üß© Create Tunnel',
    'edit.title': 'üìù Edit Config',
    'edit.restart': 'Restart service after save',
    'role.server': 'Server',
    'role.client': 'Client',
    'form.role': 'Role',
    'form.instance': 'Instance',
    'form.tunnel_mode': 'Tunnel Mode',
    'form.profile': 'Profile',
    'form.transport': 'Transport',
    'form.port': 'Port',
    'form.server_addr': 'Server Addr (client)',
    'form.listen_host': 'Listen Host (server)',
    'form.path': 'Path',
    'form.psk': 'PSK',
    'form.pool_size': 'Pool Size (client)',
    'form.strategy': 'Strategy (client)',
    'form.mux': 'Mux',
    'form.advanced_yaml': 'Advanced YAML override (optional)',
    'ph.instance': 'default',
    'ph.server_addr': '1.2.3.4',
    'ph.listen_host': 'empty = all interfaces',
    'ph.psk': 'optional',
    'ph.advanced_yaml': 'If set, this YAML is written directly.',
    'updated.prefix': '‚è∞ Updated',
    'table.no_tunnels': 'No tunnel services found.',
    'thr.down': 'Down',
    'thr.up': 'Up',
    'thr.total': 'Total',
    'action.start': 'Start',
    'action.stop': 'Stop',
    'action.restart': 'Restart',
    'action.edit': 'Edit',
    'action.delete': 'Delete',
    'logs.select_error': 'No tunnel selected for logs',
    'logs.no_output': '(no log output)',
    'editor.empty': 'Config YAML cannot be empty',
    'toast.created': 'Tunnel created/updated',
    'toast.saved': 'Saved: {{service}}',
    'toast.deleted': 'Deleted: {{service}}',
    'toast.action': '{{service}}: {{action}} requested',
    'confirm.delete': 'Delete {{service}}.service and its config?',
    'status.unknown': 'unknown',
    'time.day': 'd',
    'time.hour': 'h',
    'time.min': 'm',
  },
};

const state = {
  tunnels: [],
  editService: null,
  refreshTimer: null,
  lang: 'fa',
};

const els = {
  cpuVal: document.getElementById('cpuVal'),
  memVal: document.getElementById('memVal'),
  diskVal: document.getElementById('diskVal'),
  loadVal: document.getElementById('loadVal'),
  uptimeVal: document.getElementById('uptimeVal'),
  hostNetVal: document.getElementById('hostNetVal'),
  tunnelRows: document.getElementById('tunnelRows'),
  logService: document.getElementById('logService'),
  logsBox: document.getElementById('logsBox'),
  lastUpdated: document.getElementById('lastUpdated'),
  toast: document.getElementById('toast'),

  refreshBtn: document.getElementById('refreshBtn'),
  createBtn: document.getElementById('createBtn'),
  loadLogsBtn: document.getElementById('loadLogsBtn'),
  langSelect: document.getElementById('langSelect'),

  createModal: document.getElementById('createModal'),
  createForm: document.getElementById('createForm'),
  closeCreate: document.getElementById('closeCreate'),
  cancelCreate: document.getElementById('cancelCreate'),

  editModal: document.getElementById('editModal'),
  editForm: document.getElementById('editForm'),
  editTitle: document.getElementById('editTitle'),
  editConfigText: document.getElementById('editConfigText'),
  editRestart: document.getElementById('editRestart'),
  closeEdit: document.getElementById('closeEdit'),
  cancelEdit: document.getElementById('cancelEdit'),
};

function tr(key, vars = {}) {
  const dict = I18N[state.lang] || I18N.fa;
  const fallback = I18N.en[key] || key;
  let text = dict[key] || fallback;
  Object.entries(vars).forEach(([k, v]) => {
    text = text.replaceAll(`{{${k}}}`, String(v));
  });
  return text;
}

function applyI18n() {
  document.documentElement.lang = state.lang;
  document.documentElement.dir = state.lang === 'fa' ? 'rtl' : 'ltr';
  document.body.classList.toggle('lang-fa', state.lang === 'fa');

  document.title = tr('doc.title');
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.getAttribute('data-i18n');
    if (key) el.textContent = tr(key);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (key) el.setAttribute('placeholder', tr(key));
  });
}

async function api(path, options = {}) {
  const res = await fetch(path, {
    headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
    ...options,
  });
  const text = await res.text();
  let data = {};
  try {
    data = text ? JSON.parse(text) : {};
  } catch (_) {}
  if (!res.ok || data.ok === false) {
    const msg = data.error || `${res.status} ${res.statusText}`;
    throw new Error(msg);
  }
  return data;
}

function fmtBytes(bytes) {
  const n = Number(bytes || 0);
  if (n < 1024) return `${n.toFixed(0)} B`;
  if (n < 1024 ** 2) return `${(n / 1024).toFixed(1)} KB`;
  if (n < 1024 ** 3) return `${(n / 1024 ** 2).toFixed(1)} MB`;
  return `${(n / 1024 ** 3).toFixed(2)} GB`;
}

function fmtBps(bps) {
  const n = Number(bps || 0);
  if (n < 1024) return `${n.toFixed(0)} B/s`;
  if (n < 1024 ** 2) return `${(n / 1024).toFixed(1)} KB/s`;
  if (n < 1024 ** 3) return `${(n / 1024 ** 2).toFixed(1)} MB/s`;
  return `${(n / 1024 ** 3).toFixed(2)} GB/s`;
}

function fmtUptime(seconds) {
  const s = Math.max(0, Math.floor(Number(seconds || 0)));
  const d = Math.floor(s / 86400);
  const h = Math.floor((s % 86400) / 3600);
  const m = Math.floor((s % 3600) / 60);
  if (state.lang === 'fa') {
    if (d > 0) return `${d} ${tr('time.day')} ${h} ${tr('time.hour')} ${m} ${tr('time.min')}`;
    if (h > 0) return `${h} ${tr('time.hour')} ${m} ${tr('time.min')}`;
    return `${m} ${tr('time.min')}`;
  }
  if (d > 0) return `${d}${tr('time.day')} ${h}${tr('time.hour')} ${m}${tr('time.min')}`;
  if (h > 0) return `${h}${tr('time.hour')} ${m}${tr('time.min')}`;
  return `${m}${tr('time.min')}`;
}

function statusBadge(active, sub) {
  const a = String(active || '').toLowerCase() || tr('status.unknown');
  const s = String(sub || '').toLowerCase() || tr('status.unknown');
  if (a === 'active') return `<span class="badge ok">‚úÖ ${a}/${s}</span>`;
  if (a === 'activating' || a === 'reloading') return `<span class="badge warn">üü° ${a}/${s}</span>`;
  return `<span class="badge err">üî¥ ${a}/${s}</span>`;
}

function showToast(message, isError = false) {
  els.toast.textContent = message;
  els.toast.classList.add('show');
  els.toast.classList.toggle('error', isError);
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(() => {
    els.toast.classList.remove('show');
  }, 2600);
}

function renderResources(resources = {}) {
  const mem = resources.memory || {};
  const disk = resources.disk || {};
  const load = resources.load || { '1m': 0, '5m': 0, '15m': 0 };
  const net = resources.network || {};
  els.cpuVal.textContent = `${Number(resources.cpu_percent || 0).toFixed(1)}%`;
  els.memVal.textContent = `${Number(mem.used_percent || 0).toFixed(1)}% (${fmtBytes(mem.used)} / ${fmtBytes(mem.total)})`;
  els.diskVal.textContent = `${Number(disk.used_percent || 0).toFixed(1)}% (${fmtBytes(disk.used)} / ${fmtBytes(disk.total)})`;
  els.loadVal.textContent = `${Number(load['1m'] || 0).toFixed(2)} / ${Number(load['5m'] || 0).toFixed(2)} / ${Number(load['15m'] || 0).toFixed(2)}`;
  els.uptimeVal.textContent = fmtUptime(resources.uptime_seconds);
  els.hostNetVal.textContent = `‚Üì ${fmtBps(net.rx_bps)} ‚Ä¢ ‚Üë ${fmtBps(net.tx_bps)}`;
}

function renderLogServiceSelect() {
  const current = els.logService.value;
  els.logService.innerHTML = '';
  state.tunnels.forEach((t) => {
    const opt = document.createElement('option');
    opt.value = t.service;
    opt.textContent = `${t.service} (${t.role})`;
    els.logService.appendChild(opt);
  });
  if (current && state.tunnels.some((t) => t.service === current)) {
    els.logService.value = current;
  }
}

function tunnelActionButtons(service) {
  return `
    <div class="inline-actions">
      <button class="btn" data-action="start" data-service="${service}">‚ñ∂Ô∏è ${tr('action.start')}</button>
      <button class="btn" data-action="stop" data-service="${service}">‚èπÔ∏è ${tr('action.stop')}</button>
      <button class="btn" data-action="restart" data-service="${service}">‚ôªÔ∏è ${tr('action.restart')}</button>
      <button class="btn" data-action="edit" data-service="${service}">‚úèÔ∏è ${tr('action.edit')}</button>
      <button class="btn btn-danger" data-action="delete" data-service="${service}">üóëÔ∏è ${tr('action.delete')}</button>
    </div>
  `;
}

function renderTunnels(tunnels) {
  state.tunnels = tunnels;
  renderLogServiceSelect();

  if (!tunnels.length) {
    els.tunnelRows.innerHTML = `<tr><td colspan="7" class="muted">${tr('table.no_tunnels')}</td></tr>`;
    return;
  }

  const rows = tunnels
    .map((t) => {
      const profile = t.config?.profile || '-';
      const tunnelMode = t.config?.tunnel_mode || '-';
      const endpoints = (t.config?.endpoints || []).map((ep) => `<span class="endpoint-pill">${ep}</span>`).join(' ');
      const thr = t.throughput || { rx_bps: 0, tx_bps: 0, rx_total: 0, tx_total: 0 };

      return `
        <tr>
          <td>
            <div class="service-name">${t.service}</div>
            <div class="muted">${t.config?.config_path || ''}</div>
          </td>
          <td>${t.role}:${t.instance}</td>
          <td>${statusBadge(t.active, t.sub)}</td>
          <td><span class="profile-chip">${profile}</span> / <span class="mode-chip">${tunnelMode}</span></td>
          <td>${endpoints || '<span class="muted">-</span>'}</td>
          <td class="thr-cell">
            <div>üü¢ ${tr('thr.down')}: ${fmtBps(thr.rx_bps)}</div>
            <div>üü† ${tr('thr.up')}: ${fmtBps(thr.tx_bps)}</div>
            <div class="muted">${tr('thr.total')}: ‚Üì${fmtBytes(thr.rx_total)} / ‚Üë${fmtBytes(thr.tx_total)}</div>
          </td>
          <td>${tunnelActionButtons(t.service)}</td>
        </tr>
      `;
    })
    .join('');

  els.tunnelRows.innerHTML = rows;
}

async function loadResources() {
  const data = await api('/api/resources');
  renderResources(data.resources || {});
}

async function loadTunnels() {
  const data = await api('/api/tunnels');
  renderTunnels(data.tunnels || []);
}

async function loadAll() {
  try {
    await Promise.all([loadResources(), loadTunnels()]);
    const timeStr = new Date().toLocaleTimeString(state.lang === 'fa' ? 'fa-IR' : 'en-US');
    els.lastUpdated.textContent = `${tr('updated.prefix')}: ${timeStr}`;
  } catch (err) {
    showToast(err.message || String(err), true);
  }
}

async function loadLogs() {
  const service = els.logService.value;
  if (!service) {
    showToast(tr('logs.select_error'), true);
    return;
  }
  try {
    const data = await api(`/api/tunnels/${encodeURIComponent(service)}/logs?lines=220`);
    els.logsBox.textContent = data.logs || tr('logs.no_output');
  } catch (err) {
    showToast(err.message || String(err), true);
  }
}

async function actOnService(service, action) {
  try {
    await api(`/api/tunnels/${encodeURIComponent(service)}/action`, {
      method: 'POST',
      body: JSON.stringify({ action }),
    });
    showToast(tr('toast.action', { service, action }));
    await loadAll();
  } catch (err) {
    showToast(err.message || String(err), true);
  }
}

async function deleteService(service) {
  if (!confirm(tr('confirm.delete', { service }))) return;
  try {
    await api(`/api/tunnels/${encodeURIComponent(service)}`, { method: 'DELETE' });
    showToast(tr('toast.deleted', { service }));
    await loadAll();
  } catch (err) {
    showToast(err.message || String(err), true);
  }
}

async function openEditor(service) {
  try {
    const data = await api(`/api/tunnels/${encodeURIComponent(service)}/config`);
    state.editService = service;
    els.editTitle.textContent = `${tr('edit.title')}: ${service}`;
    els.editConfigText.value = data.config_text || '';
    els.editModal.showModal();
  } catch (err) {
    showToast(err.message || String(err), true);
  }
}

function closeEditor() {
  state.editService = null;
  els.editModal.close();
}

async function saveEditor() {
  if (!state.editService) return;
  const configText = els.editConfigText.value;
  if (!configText.trim()) {
    showToast(tr('editor.empty'), true);
    return;
  }
  try {
    await api(`/api/tunnels/${encodeURIComponent(state.editService)}/config`, {
      method: 'PUT',
      body: JSON.stringify({
        config_text: configText,
        restart: els.editRestart.checked,
      }),
    });
    showToast(tr('toast.saved', { service: state.editService }));
    closeEditor();
    await loadAll();
  } catch (err) {
    showToast(err.message || String(err), true);
  }
}

function formToPayload(form) {
  const fd = new FormData(form);
  const payload = {};
  for (const [k, v] of fd.entries()) payload[k] = String(v || '').trim();
  if (payload.port) payload.port = Number(payload.port);
  if (payload.pool_size) payload.pool_size = Number(payload.pool_size);
  return payload;
}

async function submitCreate(event) {
  event.preventDefault();
  const payload = formToPayload(els.createForm);
  try {
    await api('/api/tunnels', {
      method: 'POST',
      body: JSON.stringify(payload),
    });
    showToast(tr('toast.created'));
    els.createModal.close();
    els.createForm.reset();
    els.createForm.querySelector('select[name="profile"]').value = 'balanced';
    await loadAll();
  } catch (err) {
    showToast(err.message || String(err), true);
  }
}

function setLanguage(lang) {
  const normalized = lang === 'en' ? 'en' : 'fa';
  state.lang = normalized;
  localStorage.setItem('nodelay.webpanel.lang', normalized);
  if (els.langSelect.value !== normalized) {
    els.langSelect.value = normalized;
  }
  applyI18n();
  renderTunnels(state.tunnels);
}

function bindEvents() {
  els.refreshBtn.addEventListener('click', loadAll);
  els.createBtn.addEventListener('click', () => els.createModal.showModal());
  els.loadLogsBtn.addEventListener('click', loadLogs);
  els.langSelect.addEventListener('change', (event) => setLanguage(event.target.value));

  els.closeCreate.addEventListener('click', () => els.createModal.close());
  els.cancelCreate.addEventListener('click', () => els.createModal.close());
  els.createForm.addEventListener('submit', submitCreate);

  els.closeEdit.addEventListener('click', closeEditor);
  els.cancelEdit.addEventListener('click', closeEditor);
  els.editForm.addEventListener('submit', (e) => {
    e.preventDefault();
    saveEditor();
  });

  els.tunnelRows.addEventListener('click', (event) => {
    const button = event.target.closest('button[data-action]');
    if (!button) return;
    const action = button.dataset.action;
    const service = button.dataset.service;

    if (action === 'edit') return openEditor(service);
    if (action === 'delete') return deleteService(service);
    if (action === 'start' || action === 'stop' || action === 'restart') {
      return actOnService(service, action);
    }
    return undefined;
  });
}

async function init() {
  const storedLang = localStorage.getItem('nodelay.webpanel.lang') || 'fa';
  state.lang = storedLang === 'en' ? 'en' : 'fa';
  els.langSelect.value = state.lang;
  applyI18n();
  bindEvents();
  await loadAll();
  state.refreshTimer = setInterval(loadAll, 3000);
}

init();
